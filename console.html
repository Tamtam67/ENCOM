<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Console TRON Test</title>
<style>
  body {
    background: #000;
    color: #0ff;
    font-family: "Courier New", Courier, monospace;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #console-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    box-sizing: border-box;
  }
  #output {
    white-space: pre-wrap;
  }
  .output {
    margin-bottom: 6px;
  }
  #input-line {
    display: flex;
    border-top: 1px solid #0ff;
    padding: 8px 10px;
  }
  #prompt {
    user-select: none;
    margin-right: 5px;
  }
  #cmdline {
    background: transparent;
    border: none;
    outline: none;
    color: #0ff;
    font-family: "Courier New", Courier, monospace;
    font-size: 1rem;
    flex: 1;
  }
</style>
</head>
<body>
  <div id="console-wrapper">
    <div id="output"></div>
  </div>
  <div id="input-line">
    <div id="prompt"></div>
    <input id="cmdline" autocomplete="off" autofocus spellcheck="false" />
  </div>

<script>
(() => {
  const outputEl = document.getElementById('output');
  const inputEl = document.getElementById('cmdline');
  const promptEl = document.getElementById('prompt');
  const STORAGE_KEY = 'tronUserNameTest';

  let userName = localStorage.getItem(STORAGE_KEY) || null;
  let waitingUserName = !userName;

  // États du scénario
  let stage = 0;  // 0: attente nom ou enterGrid, 1: initializeUser, 2: runSecurityScan, 3: loadDiscWars, 4: choix canonProtocol, 5: fin canon
  let branchCanonDone = false;

  function printOutput(text) {
    const div = document.createElement('div');
    div.className = 'output';
    div.textContent = text;
    outputEl.appendChild(div);
    outputEl.parentElement.scrollTop = outputEl.parentElement.scrollHeight;
  }

  function updatePrompt() {
    promptEl.textContent = userName ? `${userName}>` : '';
  }

  function getAvailableCommands() {
    if (waitingUserName) return ['enterGrid();', 'reset', 'restart'];
    switch(stage) {
      case 0: return ['enterGrid();', 'reset', 'restart'];
      case 1: return ['initializeUser();', 'reset', 'restart'];
      case 2: return ['runSecurityScan();', 'reset', 'restart'];
      case 3: return ['loadDiscWars();', 'reset', 'restart'];
      case 4:
        return branchCanonDone
          ? ['proceedToCLU();', 'reset', 'restart']
          : ['canonProtocol();', 'reset', 'restart'];
      case 5: return ['reset', 'restart'];
      default: return ['reset', 'restart'];
    }
  }

  function showHelp() {
    const cmds = getAvailableCommands().join('\n- ');
    printOutput(`Commandes disponibles :\n- ${cmds}`);
  }

  function resetSession() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function processCommand(cmd) {
    cmd = cmd.trim();
    if (cmd === '') return;

    if (cmd === 'reset' || cmd === 'restart') {
      resetSession();
      return;
    }

    if (waitingUserName) {
      // Enregistrement du nom utilisateur
      userName = cmd.toUpperCase();
      localStorage.setItem(STORAGE_KEY, userName);
      waitingUserName = false;
      stage = 0;
      updatePrompt();
      printOutput(`Bienvenue ${userName}, vous entrez dans la Grille TRON.`);
      showHelp();
      return;
    }

    printOutput(`${userName}> ${cmd}`);

    switch(stage) {
      case 0:
        if (cmd === 'enterGrid();') {
          printOutput('[Connexion établie...]');
          printOutput('[Localisation] Grille détectée : Univers système_12.8');
          stage = 1;
          showHelp();
        } else {
          printOutput(`[ERROR] Commande inconnue à cette étape : "${cmd}"`);
          showHelp();
        }
        break;
      case 1:
        if (cmd === 'initializeUser();') {
          printOutput('[Système] Attribution du disque d\'identité...');
          printOutput('[Résultat] : Disque affecté à : SAM_FLYNN');
          stage = 2;
          showHelp();
        } else {
          printOutput(`[ERROR] Commande inconnue à cette étape : "${cmd}"`);
          showHelp();
        }
        break;
      case 2:
        if (cmd === 'runSecurityScan();') {
          printOutput('[Système] Scan complet. Statut : ANOMALIE.');
          printOutput('[ALERTE] Utilisateur non conforme. Reroutage vers l’arène de jeu...');
          stage = 3;
          showHelp();
        } else {
          printOutput(`[ERROR] Commande inconnue à cette étape : "${cmd}"`);
          showHelp();
        }
        break;
      case 3:
        if (cmd === 'loadDiscWars();') {
          printOutput('[Épreuve] Disc Wars — Adversaire : Classe élite | Identité : RINZLER');
          printOutput('> Statut de SAM : inexpérimenté');
          printOutput('> Victoire peu probable');
          printOutput('Choisissez votre protocole de réaction :');
          printOutput('1. canonProtocol();     // Suivre le film : Sam est vaincu mais capturé');
          stage = 4;
          showHelp();
        } else {
          printOutput(`[ERROR] Commande inconnue à cette étape : "${cmd}"`);
          showHelp();
        }
        break;
      case 4:
        if (cmd === 'canonProtocol();') {
          printOutput('[Résultat] : Combat lancé. Rinzler neutralise Sam sans le derezzer.');
          printOutput('[Conséquence] : Sam est capturé et emmené vers CLU.');
          branchCanonDone = true;
          stage = 5;
          showHelp();
        } else {
          printOutput(`[ERROR] Commande inconnue à cette étape : "${cmd}"`);
          showHelp();
        }
        break;
      case 5:
        printOutput('Fin de la séquence canon TRON. Tapez reset ou restart pour recommencer.');
        break;
      default:
        printOutput(`[ERROR] État inattendu : "${stage}"`);
        showHelp();
        break;
    }
  }

  // Initialisation
  updatePrompt();

  if (waitingUserName) {
    printOutput('Veuillez entrer votre nom d\'utilisateur (ex : SAM_FLYNN) :');
  } else {
    printOutput(`Bienvenue ${userName}, tapez "enterGrid();" pour commencer.`);
    showHelp();
  }

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = inputEl.value;
      inputEl.value = '';
      processCommand(cmd);
    }
  });
})();
</script>
</body>
</html>
